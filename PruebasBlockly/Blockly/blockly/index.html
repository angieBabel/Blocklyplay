<!DOCTYPE html >
<html lang="en">
<head>
<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
<title>Panel inicial</title>
<!-- Responsive css
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">-->
<link rel="stylesheet" href="styles.css">

 <!-- Angular Material style sheet -->
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0-rc2/angular-material.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!-- Angular Material requires Angular.js Libraries-->
  <script type="text/javascript"  src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.3/angular.min.js"></script>
  <script type="text/javascript"  src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.3/angular-animate.min.js"></script>
  <script type="text/javascript"  src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.3/angular-aria.min.js"></script>
  <script type="text/javascript"  src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.3/angular-messages.min.js"></script>

  <!-- Angular Material Library -->
  <script type="text/javascript"  src="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0-rc2/angular-material.min.js"></script>

<!-- interprete de JS -->
<script type="text/javascript" src="acorn_interpreter.js"></script>
<script type="text/javascript" src="acorn.js"></script>
<script type="text/javascript" src="interpreter.js"></script>
<!-- <script src="/storage.js"></script> -->
<script type="text/javascript" src="blockly_compressed.js"></script>
<script type="text/javascript" src="blocks_compressed.js"></script>
<script type="text/javascript" src="javascript_compressed.js"></script>
<script type="text/javascript" src="core/css.js"></script>
<script type="text/javascript" src="core/blockly.js"></script>
<script type="text/javascript" src="msg/js/en.js"></script>
<script type="text/javascript" src="blocks/custom.js"></script>
<script type="text/javascript" src="generators/javascript/custom.js"></script>
<script type="text/javascript" src="moves.js"></script>
<script type="text/javascript" src="filesaver.js"></script>
<script type="text/javascript" src="Blob.js"></script>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="controlFunctions.js"></script>
<script type="text/javascript">
//'use strict';
    /*var image;*/
    var img= new Image();
    var X;
    var Y;
    var r,n=0;
    var Xaux=0,Yaux=0,limtX,limtY;
    var stepsize=20;
    var initX=0,initY=0;
    var interval,time=2000;
    var c=0,acabo=1;
    var colorPath='';
    var himg=40;
    var wimg=20;
    var roadpaint = [];
    var count=0;
    var luz=0,luzTrasera=0;
    var ctx;
    var ancho,alto;

    var positionObj = {
      objX: 0,
      objY: 0,
      objZ: 0,
    };

    function begin(){
      canvas = document.getElementById('canvas');

      canvas.style.margin='0px 0px 0px 10px';
      ctx = canvas.getContext('2d');
      ancho = document.getElementById('divCanvas').offsetWidth;
      alto = document.getElementById('divCanvas').offsetHeight;
      canvas.width= ancho;
      canvas.height = alto;
      //alert(ancho +','+ alto);

      X = canvas.width/2;
      Y = canvas.height/2;
      r = 10;
      positionObj.objX=X;
      positionObj.objY=Y;
       roadpaint.push(X+","+Y);
      Xaux = positionObj.objX;
      Yaux= positionObj.objY;
      panel(0);
    }

    function stopTimer(){
      clearInterval(interval);
    }

    function panel(level){
      var imgback = new Image();
      //var imgback = document.images.fondo;
      imgback.src = "media/panelPrincipal.png";
     imgback.onload = function() {
        ctx.beginPath();
        ctx.drawImage(imgback, 0, 0,ancho,alto);
        Avatar();
      }

    }

    function paintroad(){
      for (var i = 0; i <road.length; i++) {
        ctx.strokeStyle = "#f00";
        ctx.beginPath();
        ctx.moveTo(road[i]);
        ctx.lineTo(road[i+1]);
        ctx.stroke();
      };
    }
    //Drawing avatar

    function Avatar(){
      var avatarheight, avatarwith;
      var positionX, positionY;

      img.id = 'imagen';
      img.src = 'media/avatar.png';
      avatarwith=100;avatarheight=130;
      positionX=X-(avatarwith/2); positionY=canvas.height-250;

      img.onload = function() {
        ctx.drawImage(img,positionX, positionY,avatarwith,avatarheight);
      }
    }

    //path forward
    function path(){
      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "gray";
      ctx.rect(X, Y-100, 100, 100);
      ctx.stroke();
    }

    function ocultar(){
      //$('.blocklyToolboxDiv').css({'width':'20px'});
       $('.blocklyToolboxDiv').toggle('slow');
    }
</script>
</head>
<body onload="begin()" ng-app="Blocklyplay" ng-style="{'background-color':'#EEEEEE'}">
  <div layout="row" layout-wrap id="menu">
    <div flex="10">
      <md-button class="md-icon-button md-primary" aria-label="Settings" onclick="ocultar()" >
        <md-icon >
          <i class="material-icons">dehaze</i>
        </md-icon>
      </md-button>
      <!--<button onclick="ocultar()"><i class="fa fa-bars " aria-hidden="true"></i></button>-->
    </div>
    <div flex="30">
      <p>Instructions</p>
    </div>
    <div flex='40'>
      <md-button class="md-fab md-mini" aria-label="Panel" ng-style="{'background-color':'#00E676'}" onclick="location.href = 'index.html'">
        <md-icon ></md-icon>
      </md-button>
      <md-button class="md-fab md-mini" aria-label="Panel" ng-style="{'background-color':'#00B0FF'}"onclick="location.href = 'panel1.html'" >
        <md-icon ></md-icon>
      </md-button>
      <md-button class="md-fab md-mini" aria-label="Panel" ng-style="{'background-color':'#2979FF'}"onclick="location.href = 'panel2.html'" >
        <md-icon ></md-icon>
      </md-button>
      <md-button class="md-fab md-mini" aria-label="Panel" ng-style="{'background-color':'#651FFF'}"onclick="location.href = 'panel3.html'">
        <md-icon ></md-icon>
      </md-button>
      <md-button class="md-fab md-mini" aria-label="Panel" ng-style="{'background-color':'#D500F9'}"onclick="location.href = 'panel4.html'">
        <md-icon ></md-icon>
      </md-button>
      <md-button class="md-fab md-mini" aria-label="Panel" ng-style="{'background-color':'#FF1744'}"onclick="location.href = 'panel5.html'">
        <md-icon ></md-icon>
      </md-button>
    </div>
    <div flex='20'>
        <md-button class="md-warn md-raised md-hue-2" ng-style="{'background-color':'#FFC400',}">
          Instructions <i class="material-icons">help_outline</i>
        </md-button>
    </div>

  </div>
  <div layout="row" id="blocklyArea">
    <div flex='40'>
        <div id="blocklyDiv" style="position: absolute" ></div>
    </div>

    <div flex='60' id="divCanvas">

        <canvas id="canvas"></canvas>

    </div>
  </div>
  <div layout="row">
    <div flex>
      <md-button  onclick="runCode()" class="md-raised md-cornered btnfunction" ng-style="{'background-color':'#64DD17','border-radius':'10px','border-color': '10px solid white', 'color':'white'}">Run code<i class="material-icons">&#xE039;</i></md-button>
    </div>
    <div flex>
      <md-button  onclick="saveXML()" class="md-raised md-cornered btnfunction" ng-style="{'background-color':'#FF5252','border-radius':'10px','border-color': '10px solid white', 'color':'white'}">Save project </md-button>
    </div>
    <div flex>
      <md-button onclick="showCode()" class="md-raised md-cornered btnfunction" ng-style="{'background-color':'#0091EA','border-radius':'10px', 'color':'white','border-color': '10px solid white'}">Show JavaScript</md-button>
    </div>
  </div>

<xml id="toolbox" style="display: none">
  <category name="Control" colour="355">
    <block type="wait"></block>
    <block type="stop"></block>
    <block type="controls_repeat_ext">
      <value name="TIMES">
        <shadow type="math_number">
          <field name="NUM">10</field>
        </shadow>
      </value>
    </block>
    <block type="controls_whileUntil"></block>
    <block type="controls_for">
      <value name="FROM">
        <shadow type="math_number">
          <field name="NUM">1</field>
        </shadow>
      </value>
      <value name="TO">
        <shadow type="math_number">
          <field name="NUM">10</field>
        </shadow>
      </value>
      <value name="BY">
        <shadow type="math_number">
          <field name="NUM">1</field>
        </shadow>
      </value>
    </block>
    <block type="controls_flow_statements"></block>
  </category>

  <category name="Move" colour="79">
    <block type="mover"></block>
    <block type="mover_pintando"></block>
    <block type="girar"></block>
  </category>

  <category name="Lights" colour="176">
    <block type="blinker"></block>
    <block type="lights"></block>
  </category>

  <category name="Sounds" colour="290">
    <block type="sonido"></block>
  </category>

  <category name="Math" colour="190">
    <block type="math_number" gap="32"></block>
    <block type="math_arithmetic">
      <value name="A">
        <shadow type="math_number">
          <field name="NUM">1</field>
        </shadow>
      </value>
      <value name="B">
        <shadow type="math_number">
          <field name="NUM">1</field>
        </shadow>
      </value>
    </block>
  </category>

  <category name="Text" colour="210">
    <block type="text"></block>
    <block type="text_isEmpty">
      <value name="VALUE">
        <shadow type="text">
          <field name="TEXT"></field>
        </shadow>
      </value>
    </block>
    <block type="text_print">
      <value name="TEXT">
        <shadow type="text">
          <field name="TEXT">abc</field>
        </shadow>
      </value>
    </block>
    <block type="text_prompt_ext">
      <value name="TEXT">
        <shadow type="text">
           <field name="TEXT">abc</field>
        </shadow>
      </value>
    </block>
  </category>

  <category name="Logic" colour="25">
    <block type="controls_if"></block>
    <block type="logic_compare"></block>
    <block type="logic_operation"></block>
    <block type="logic_negate"></block>
    <block type="logic_boolean"></block>
  </category>

  <category name="Colour" colour="160">
    <block type="colour_picker"></block>
    <block type="colour_random"></block>
    <block type="colour_rgb">
      <value name="RED">
        <shadow type="math_number">
          <field name="NUM">100</field>
        </shadow>
      </value>
      <value name="GREEN">
        <shadow type="math_number">
          <field name="NUM">50</field>
        </shadow>
      </value>
      <value name="BLUE">
        <shadow type="math_number">
          <field name="NUM">0</field>
        </shadow>
      </value>
    </block>
    <block type="colour_blend">
      <value name="COLOUR1">
        <shadow type="colour_picker">
          <field name="COLOUR">#ff0000</field>
        </shadow>
      </value>
      <value name="COLOUR2">
        <shadow type="colour_picker">
          <field name="COLOUR">#3333ff</field>
        </shadow>
      </value>
      <value name="RATIO">
        <shadow type="math_number">
          <field name="NUM">0.5</field>
        </shadow>
      </value>
    </block>
  </category>

  <sep></sep>
  <category name="Variables" colour="330" custom="VARIABLE"></category>
  <category name="Functions" colour="46" custom="PROCEDURE"></category>

</xml>
<script type="text/javascript">
  var myWidth = 0, myHeight = 0;
    function alertSize() {

      if( typeof( window.innerWidth ) == 'number' ) {
        //No-IE
        myWidth = window.innerWidth;
        myHeight = window.innerHeight;
      } else if( document.documentElement && ( document.documentElement.clientWidth || document.documentElement.clientHeight ) ) {
        //IE 6+
        myWidth = document.documentElement.clientWidth;
        myHeight = document.documentElement.clientHeight;
      } else if( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
        //IE 4 compatible
        myWidth = document.body.clientWidth;
        myHeight = document.body.clientHeight;
      }
      /*window.alert( 'Width = ' + myWidth );
      window.alert( 'Height = ' + myHeight ); */

    }
    alertSize();

'use strict';
    var blocklyArea = document.getElementById('blocklyArea');
    var blocklyDiv = document.getElementById('blocklyDiv');
    var blocklyCanvas = document.getElementById('divCanvas');
    var workspace = Blockly.inject(blocklyDiv,
        { media: 'media/',
          zoom:
           {controls: true,
            wheel: true,
            startScale: 1.0,
            maxScale: 3,
            minScale: 0.3,
            scaleSpeed: 1.2},
          toolbox: document.getElementById('toolbox')});

  var onresize = function(e) {
    // Compute the absolute coordinates and dimensions of blocklyArea.
    var element = blocklyArea;
    var x = 0;
    var y = 0;
    do {
      x += element.offsetLeft;
      y += element.offsetTop;
      element = element.offsetParent;
    } while (element);
    //alert(blocklyArea.offsetWidth)
    // Position blocklyDiv over blocklyArea.
    blocklyDiv.style.left = x + 'px';
    //blocklyDiv.style.top = y + 'px';

    blocklyDiv.style.width = (myWidth*.4) + 'px';
    blocklyDiv.style.height = (myHeight*.85)+ 'px';
    blocklyCanvas.style.height= (myHeight*.85)+ 'px';
    };

  window.addEventListener('resize', onresize, false);
  onresize();



  var program = window.localStorage.getItem("panel");
  Blockly.mainWorkspace.clear();
  var textToDom = Blockly.Xml.textToDom(program);
  Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, textToDom);

function showCode() {
  // Generate JavaScript code and display it.
  Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
  Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
  Blockly.JavaScript.addReservedWords('highlightBlock');
  var code = Blockly.JavaScript.workspaceToCode(workspace);
  //////
  /*
    var allXml = Blockly.Xml.workspaceToDom(workspace);
    var allCode = [];
    for (var i = 0, xml; xml = allXml[i]; i++) {
      var headless = new Blockly.Workspace();
      Blockly.Xml.domToWorkspace(headless, xml);
      allCode.push(Blockly.JavaScript.workspaceToCode(headless));
      headless.dispose();
    }
  */

  //////
  myInterpreter = new Interpreter(code, initAlert);
  highlightPause = false;
  workspace.traceOn(true);
  workspace.highlightBlock(null);
  alert(code);

}
function nextStep() {
  if (highlightPause) {
    // A block has been highlighted.  Pause execution here.
    highlightPause = false;
  } else {
    // Keep executing until a highlight statement is reached.
    /*stepCode();*/
  }
  if (!myInterpreter.step()) {
    /*window.setTimeout(finish, 15);*/
    clearInterval(intervalo);
    if (positionObj.objY==Y && positionObj.objX==X) {
      alert('Felicidades, haz completado correctamente el puzzle');
    }
    else{
      alert('Esta vez no lo conseguiste, intenta de nuevo');
      //location.reload();
    }
  }
}
function finish(){
  if(acabo==1){
        nextStep();
      }
}

function runCode() {
  showCode();
  intervalo= setInterval(function(){finish();},15)
  var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
  var domToPretty = Blockly.Xml.domToPrettyText(xml);

  window.localStorage.setItem("panel", domToPretty);
}

function saveXML(){
  var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
  var mappingData = window.localStorage.getItem('mappingBlock');
  var conditionData = window.localStorage.getItem('conditionBlock');


  var data = Blockly.Xml.domToPrettyText(xml);
  console.log(data);
  //return;


  var name = prompt("Name of this file", "blocks");
  if (name) {
    var blob = new Blob([data], {
      type: "text/plain;charset=utf-8"
    });
    saveAs(blob, name + '.xml');
  }

}
</script>
<script type="text/javascript">
'use strict';
    /**
     * You must include the dependency on 'ngMaterial'
     */
    angular.module('Blocklyplay', ['ngMaterial']);
  </script>
</body>
</html>




