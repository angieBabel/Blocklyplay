<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HTML5 - Nave en movimiento</title>
  <!-- interprete de JS -->
  <script src="acorn_interpreter.js"></script>
  <script src="acorn.js"></script>
  <script src="interpreter.js"></script>
  <script src="/storage.js"></script>

  <script src="blockly_compressed.js"></script>
  <script src="blocks_compressed.js"></script>
  <script src="javascript_compressed.js"></script>
  <script src="msg/js/en.js"></script>
  <script src="blocks/custom.js"></script>
  <script src="generators/javascript/custom.js"></script>
  <script type="text/javascript" src="moves.js"></script>
  <style>
    canvas {
        background: #fff;
    }
  </style>
<script type="text/javascript">
    /*var image;*/
    var img= new Image();
    var X;
    var Y;
    var r;
    var Xaux=0,Yaux=0,limtX,limtY;
    var stepsize=20;
    var initX=0,initY=0;
    var interval,time=2000;
    var c=0,acabo=1;
    var rotation;
    var costheta;
    var sintheta;

    var positionObj = {
      objX: 0,
      objY: 0,
      objZ: 0,
    };
    function begin(){
      canvas = document.getElementById('canvas');
      canvas.style.border='1px solid black';
      ctx = canvas.getContext('2d');
      X = canvas.width/2;
      Y = canvas.height/2;
      r = 10;
      positionObj.objX=X;
      positionObj.objY=Y;
      Xaux = positionObj.objX;
      Yaux= positionObj.objY;
      panel();
      Avatar();
      path();

    }

    function stopTimer(){
      clearInterval(interval);
    }

    function panel(){
      while(initX<canvas.width-stepsize){
        initX=initX+stepsize;
        while(initY<canvas.height-stepsize){
          initY=initY+stepsize;
          ctx.beginPath();
          ctx.fillStyle = "#E3E2E2";
          ctx.arc(initX,initY,1.5,0,2*Math.PI);
          ctx.fill();
        }
        initY=0;
      }
      initX=0;
    }

    //function sipin
    function spin(grade){

    }
    //Drawing avatar
    function Avatar(){

      img.src = 'media/carro.png';
      img.id = 'imagen';
      img.onload = function() {
      ctx.drawImage(img,X-20,Y-10,40,20);
      }
    }

    //path forward
    function path(){
      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "gray";
      ctx.rect(X, Y-100, 100, 100);
      ctx.stroke();
    }
</script>
<script type="text/javascript">
    var myInterpreter=null;
    function initAlert(interpreter, scope) {
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(wrapper));
      // Add an API function for the prompt() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };
      interpreter.setProperty(scope, 'prompt',
          interpreter.createNativeFunction(wrapper));

      // Add an API function for highlighting blocks.
      var wrapper = function(id) {
        id = id ? id.toString() : '';
        return interpreter.createPrimitive(highlightBlock(id));
      };
      interpreter.setProperty(scope, 'highlightBlock',
          interpreter.createNativeFunction(wrapper));

      //Moves Funcitons
        //Move forward
        var wrapper = function(nosteps) {
          return interpreter.createPrimitive(forward(nosteps));
        }
        interpreter.setProperty(scope, 'forward',
            interpreter.createNativeFunction(wrapper));

        //Move backward
        var wrapper = function(nosteps) {
          return interpreter.createPrimitive(backward(nosteps));
        }
        interpreter.setProperty(scope, 'backward',
            interpreter.createNativeFunction(wrapper));

        //Move upward
        var wrapper = function(nosteps) {
          return interpreter.createPrimitive(upward(nosteps));
        }
        interpreter.setProperty(scope, 'upward',
            interpreter.createNativeFunction(wrapper));

        //Move downward
        var wrapper = function(nosteps) {
          return interpreter.createPrimitive(downward(nosteps));
        }
        interpreter.setProperty(scope, 'downward',
            interpreter.createNativeFunction(wrapper));

        var wrapper = function(angulo,side) {
          return interpreter.createPrimitive(rotar(angulo,side));
        }
        interpreter.setProperty(scope, 'rotar',
            interpreter.createNativeFunction(wrapper));



    }
    var highlightPause = false;
    function highlightBlock(id) {
      workspace.highlightBlock(id);
      highlightPause = true;
    }
</script>
</head>
<body onload="begin()">
<table>

<!-- <button onclick="showCode()">Show JavaScript</button> -->
<button onclick="runCode()">Run JavaScript</button>
  <td><canvas id="canvas" height="480" width="600" ></canvas></td>
  <td><div id="blocklyDiv" style="height: 480px; width: 600px;"></div>
</td>
</table>


<xml id="toolbox" style="display: none">
    <category name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
    </category>
    <category name="Text">
      <block type="text"></block>
      <block type="text_length"></block>
      <block type="text_print"></block>
    </category>
    <category name="Variables" custom="VARIABLE"></category>
    <category name="custom">
      <block type="mover"></block>
      <block type="girar"></block>
      <block type="wait"></block>
      <block type="stop"></block>
      <block type="blinker"></block>
      <block type="lights"></block>

    </category>
</xml>
<xml id="startBlocks" style="display: none">
    <block type="mover" inline="true">
      <field name="nosteps">5</field>
      <field name="direction"><!-- Forward --></field>
      <next>
        <block type="mover" >
          <field name="nosteps">5</field>
          <field name="direction"><!-- Upward --></field>
           <next>
              <block type="mover" >
                <field name="nosteps">5</field>
                <field name="direction"><!-- Backward --></field>
                <next>
                  <block type="mover" >
                    <field name="nosteps">5</field>
                    <field name="direction"><!-- Downward --></field>
                  </block>
                </next>
              </block>
          </next>
        </block>

      </next>

    </block>
</xml>
<script type="text/javascript">
  var workspace = Blockly.inject('blocklyDiv',
      {media: 'media/',
       toolbox: document.getElementById('toolbox')});
  var program = window.localStorage.getItem("panel2");
  Blockly.mainWorkspace.clear();
  var textToDom = Blockly.Xml.textToDom(program);
  Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, textToDom);

    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('highlightBlock');
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      myInterpreter = new Interpreter(code, initAlert);
      highlightPause = false;
      workspace.traceOn(true);
      workspace.highlightBlock(null);
    }
    function nextStep() {
      if (highlightPause) {
        // A block has been highlighted.  Pause execution here.
        highlightPause = false;
      } else {
        // Keep executing until a highlight statement is reached.
        /*stepCode();*/
      }
      if (!myInterpreter.step()) {
        /*window.setTimeout(finish, 15);*/
        clearInterval(intervalo);
        if (positionObj.objY==Y && positionObj.objX==X) {
          alert('Felicidades, haz completado correctamente el puzzle');
        }
        else{
          alert('Esta vez no lo conseguiste, intenta de nuevo');
          location.reload();
        }
      }
    }
    function finish(){
      if(acabo==1){
            nextStep();
          }
    }

    function runCode() {
      showCode();
      intervalo= setInterval(function(){finish();},15)
      var xml = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
      var domToPretty = Blockly.Xml.domToPrettyText(xml);
      window.localStorage.setItem("panel2", domToPretty);
    }
</script>
</body>
</html>
