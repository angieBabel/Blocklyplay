<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HTML5 - Nave en movimiento</title>
  <!-- interprete de JS -->
  <script src="acorn_interpreter.js"></script>
  <script src="acorn.js"></script>
  <script src="interpreter.js"></script>

  <script src="blockly_compressed.js"></script>
  <script src="blocks_compressed.js"></script>
  <script src="javascript_compressed.js"></script>
  <script src="msg/js/en.js"></script>
  <script src="blocks/custom.js"></script>
  <script src="generators/javascript/custom.js"></script>
  <script type="text/javascript" src="moves.js"></script>
  <style>
    canvas {
        background: #fff;
    }
  </style>
<script type="text/javascript">
  var codigos;
  var n;
    var image;
    var X;
    var Y;
    var r;
    var Xaux=0,Yaux=0,limtX,limtY;
    var stepsize=20;
    var initX=0,initY=0;
    var interval;

    var positionObj = {
      objX: 0,
      objY: 0,
    };
    function begin(){
      canvas = document.getElementById('canvas');
      canvas.style.border='1px solid black';
      ctx = canvas.getContext('2d');
      X = canvas.width/2;
      Y = canvas.height/2;
      r = 10;
      positionObj.objX=X;
      positionObj.objY=Y;
      Xaux = positionObj.objX;
      Yaux= positionObj.objY;
      panel();
      Avatar();
      path();
    }

    function stopTimer(){
      clearInterval(interval);
    }

    function panel(){
      while(initX<canvas.width-stepsize){
        initX=initX+stepsize;
        while(initY<canvas.height-stepsize){
          initY=initY+stepsize;
          ctx.beginPath();
          ctx.fillStyle = "#E3E2E2";
          ctx.arc(initX,initY,1.5,0,2*Math.PI);
          ctx.fill();
        }
        initY=0;
      }
      initX=0;
    }

    //function sipin
    function spin(grade){

    }
    //Drawing avatar
    function Avatar(){
      ctx.beginPath();
      ctx.strokeStyle = "#006400";
      ctx.fillStyle = "#6ab150";
      ctx.lineWidth = 2;
      ctx.arc(X,Y,r,0,2*Math.PI);
      ctx.fill();
      ctx.stroke();
    }
    //path forward
    function path(){
      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "gray";
      ctx.rect(X, Y-100, 100, 100);
      ctx.stroke();

    }
</script>
<script type="text/javascript">
    var myInterpreter=null;
    function initAlert(interpreter, scope) {
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(wrapper));
      // Add an API function for the prompt() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };
      interpreter.setProperty(scope, 'prompt',
          interpreter.createNativeFunction(wrapper));

      // Add an API function for highlighting blocks.
      var wrapper = function(id) {
        id = id ? id.toString() : '';
        return interpreter.createPrimitive(highlightBlock(id));
      };
      interpreter.setProperty(scope, 'highlightBlock',
          interpreter.createNativeFunction(wrapper));
    }
    var highlightPause = false;
    function highlightBlock(id) {
      workspace.highlightBlock(id);
      highlightPause = true;
    }
</script>
</head>
<body onload="begin()">
<table>

<button onclick="showCode()">Show JavaScript</button>
<button onclick="runCode()">Run JavaScript</button>
  <td><canvas id="canvas" height="480" width="600" ></canvas></td>
  <td><div id="blocklyDiv" style="height: 480px; width: 600px;"></div>
</td>
</table>


<xml id="toolbox" style="display: none">
    <category name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
    </category>
    <category name="Text">
      <block type="text"></block>
      <block type="text_length"></block>
      <block type="text_print"></block>
    </category>
    <category name="Variables" custom="VARIABLE"></category>
    <category name="custom">
      <block type="dibujar"></block>
      <block type="pasos_adelante"></block>
      <block type="pasos_arriba"></block>
      <block type="pasos_atras"></block>
      <block type="mover"></block>
      <!-- <block type="paso"></block> -->
    </category>
</xml>
<script type="text/javascript">
  var workspace = Blockly.inject('blocklyDiv',
      {media: 'media/',
       toolbox: document.getElementById('toolbox')});

//inicializano el interprete de JS
  /*Blockly.Xml.domToWorkspace(workspace,
      document.getElementById('startBlocks'));*/


    function showCode() {
      // Generate JavaScript code and display it.
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('highlightBlock');
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      myInterpreter = new Interpreter(code, initAlert);
      highlightPause = false;
      workspace.traceOn(true);
      workspace.highlightBlock(null);

      alert(code+' '+myInterpreter);
      codigos=code.split("\n");
      var n=0;
    }

    function nextStep() {
      if (highlightPause) {
        // A block has been highlighted.  Pause execution here.
        highlightPause = false;
      } else {
        // Keep executing until a highlight statement is reached.
        /*stepCode();*/
      }
      if (myInterpreter.step()) {
       /* eval(codigos[n]);
        n=n+1;*/
        window.setTimeout(nextStep, 15);
      }

    }
    function runCode() {
      nextStep();

      /*var code = Blockly.JavaScript.workspaceToCode(workspace);
      var myInterpreter = new Interpreter(code);
      myInterpreter.run();*/

      // Generate JavaScript code and run it.
      /*window.LoopTrap = 1000;
      Blockly.JavaScript.INFINITE_LOOP_TRAP =
          'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }*/
      /*Blockly.JavaScript.addReservedWords('code');
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }*/
    }
</script>
</body>
</html>
